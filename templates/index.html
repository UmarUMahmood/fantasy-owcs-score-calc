<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy OWCS Dashboard</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <style>
        html {
            color-scheme: dark;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #ffffff;
            margin: 0;
            padding: 0;
            background-color: #181a1b;
        }

        .header {
            background-color: #131516;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .header-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            color: #ec8302;
            text-align: center;
            margin: 0 0 20px 0;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 0;
        }

        .nav-tab {
            background-color: #3a3e41;
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background-color: #ec8302;
            color: #000;
        }

        .nav-tab:hover:not(.active) {
            background-color: #4a4e51;
        }

        .main-content {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .tab-content {
            display: none;
            background-color: #131516;
            padding: 30px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .tab-content.active {
            display: block;
        }

        /* Match Calculator Styles */
        .match-links {
            margin-bottom: 20px;
            text-align: center;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #3a3e41;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #2a2d30;
            color: #ffffff;
        }
        
        button {
            background-color: #A35A00;
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: rgb(243, 135, 2);
        }
        
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        #result {
            background-color: #181818;
            padding: 20px;
            border-radius: 4px;
            white-space: pre;
            font-family: monospace;
            overflow-x: auto;
            display: block;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .copy-btn {
            margin-top: 15px;
            background-color: #6c757d;
        }
        
        .copy-btn:hover {
            background-color: #5a6268;
        }
        
        .success-message {
            color: green;
            margin-left: 10px;
            display: none;
        }

        /* Leaderboard and Transfer Styles */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .controls > div, .controls-row > div {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .controls label, .controls-row label {
            font-size: 14px;
            margin-bottom: 0;
            font-weight: normal;
        }

        .controls input, .controls select, .controls-row input, .controls-row select {
            background-color: #2a2d30;
            color: #ffffff;
            border: 1px solid #3a3e41;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }

        /* Player Filter - Horizontal Layout */
        .player-filter-container {
            min-width: 300px;
            flex: 1;
            max-width: 100%;
        }

        .player-filter-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 0;
            border-bottom: 2px solid #3a3e41;
            margin-bottom: 10px;
        }

        .player-filter-header:hover {
            color: #ec8302;
        }

        .filter-arrow {
            transition: transform 0.3s ease;
            font-size: 16px;
            color: #ec8302;
        }

        .filter-arrow.expanded {
            transform: rotate(180deg);
        }

        .selected-count {
            background-color: #ec8302;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: auto;
        }

        .player-filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .player-filter-content.expanded {
            max-height: 600px;
        }

        .filter-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .reset-filter-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .reset-filter-btn:hover {
            background-color: #5a6268;
        }

        .exact-match-container {
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(236, 131, 2, 0.1);
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid rgba(236, 131, 2, 0.3);
        }

        .exact-match-container input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        .exact-match-container label {
            margin: 0;
            font-size: 12px;
            cursor: pointer;
            color: #ec8302;
            font-weight: bold;
        }

        .role-section {
            margin-bottom: 20px;
        }

        .role-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #3a3e41;
        }

        .role-title.tank { color: #ff6b35; }
        .role-title.damage { color: #ff1744; }
        .role-title.support { color: #00e676; }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .player-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .player-checkbox input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .player-checkbox label {
            cursor: pointer;
            margin-bottom: 0;
            font-size: 14px;
            user-select: none;
        }

        .gameweek-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3e41;
            padding-bottom: 10px;
        }

        .gameweek-tab {
            background-color: #3a3e41;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .gameweek-tab.active {
            background-color: #ec8302;
            color: #000;
        }

        .gameweek-tab:hover:not(.active) {
            background-color: #4a4e51;
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background-color: #2a2d30;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
            flex: 1;
        }

        .stat-card h3 {
            margin: 0 0 5px 0;
            color: #ec8302;
            font-size: 24px;
        }

        .stat-card p {
            margin: 0;
            color: #ccc;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            background-color: #2a2d30;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #3a3e41;
            word-wrap: break-word;
            position: relative;
        }

        th {
            background-color: #3a3e41;
            color: #ec8302;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 28px;
        }

        th:hover {
            background-color: #4a4e51;
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 14px;
            width: 12px;
            text-align: center;
        }

        th.sort-asc::after {
            content: '↑';
            opacity: 1;
            color: #ec8302;
        }

        th.sort-desc::after {
            content: '↓';
            opacity: 1;
            color: #ec8302;
        }

        tr:nth-child(even) {
            background-color: #1e2021;
        }

        tr:hover {
            background-color: #2a2d30;
        }

        .position-change {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .position-up {
            color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }

        .position-down {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .position-same {
            color: #6c757d;
        }

        .role-tank { color: #ff6b35; font-weight: bold; }
        .role-dps { color: #ff1744; font-weight: bold; }
        .role-support { color: #00e676; font-weight: bold; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            color: #777;
            font-size: 14px;
            padding: 20px;
        }

        a { 
            color: #3391ff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ec8302;
        }

        .transfer-list {
            font-size: 12px;
            color: #ccc;
        }

        .transfer-in {
            color: #28a745;
        }

        .transfer-out {
            color: #dc3545;
        }

        /* Color coding for position changes */
        .change-huge-up { background-color: rgba(40, 167, 69, 0.3) !important; }
        .change-big-up { background-color: rgba(40, 167, 69, 0.2) !important; }
        .change-small-up { background-color: rgba(40, 167, 69, 0.1) !important; }
        .change-huge-down { background-color: rgba(220, 53, 69, 0.3) !important; }
        .change-big-down { background-color: rgba(220, 53, 69, 0.2) !important; }
        .change-small-down { background-color: rgba(220, 53, 69, 0.1) !important; }

        /* Responsive table headers */
        @media (max-width: 1200px) {
            th, td {
                font-size: 12px;
                padding: 8px 4px;
            }
        }

        @media (max-width: 768px) {
            .main-content, .header-content {
                padding: 0 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .player-filter-container {
                min-width: 100%;
                max-width: 100%;
            }

            .stats-summary {
                justify-content: center;
            }

            th, td {
                font-size: 11px;
                padding: 6px 2px;
            }

            .players-list {
                gap: 10px;
            }

            .player-checkbox {
                font-size: 13px;
            }

            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Fantasy OWCS Dashboard</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchMainTab('match-calculator')">Match Calculator</button>
                <button class="nav-tab" onclick="switchMainTab('leaderboards')">Leaderboards</button>
                <button class="nav-tab" onclick="switchMainTab('transfers')">Player Transfers</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Match Calculator Tab -->
        <div id="match-calculator" class="tab-content active">
            <div class="match-links">
                Get a match link from FACEIT here (<a href="https://www.faceit.com/en/home">sign-in on FACEIT</a> if it doesn't work):
                <a href="https://www.faceit.com/en/ow2/league/FACEIT%20League/88c7f7ec-4cb8-44d3-a5db-6e808639c232/19cfb5d9-6a70-45cc-904f-2e8ef6f80a4b/matches?region=65b085e4-7e28-49f3-a6c1-9e12faaa343b&division=47812350-e0c6-48fd-8ff9-19d184236957&stage=ccea29fe-582e-4619-8afa-858bacc89a4f&conference=6306d719-8c2d-471c-bc42-421ada64911b" target="_blank">FACEIT EMEA Matches</a> | 
                <a href="https://www.faceit.com/en/ow2/league/FACEIT%20League/88c7f7ec-4cb8-44d3-a5db-6e808639c232/19cfb5d9-6a70-45cc-904f-2e8ef6f80a4b/matches?region=e80b15e5-92eb-4500-8814-2353162a4727&division=d9e85be4-5622-430f-9f3f-f2f39485d28b&stage=ad5d41df-d838-4358-9cb0-dc464b79624e&conference=83cf0d5b-329b-4ac7-80c0-282238c336e3" target="_blank">FACEIT NA Matches</a>
            </div>

            <form id="matchForm">
                <label for="matchUrl">Paste FACEIT Match URL:</label>
                <input type="text" id="matchUrl" name="match_url" placeholder="https://www.faceit.com/en/ow2/room/1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" required>
                
                <button type="submit">Generate Report</button>
            </form>
            
            <div id="loading">
                <p>Processing match data... This may take a few moments.</p>
            </div>
            
            <div id="result-container" style="display: none;">
                <div id="result"></div>
                <div style="text-align: right;">
                    <button id="copyBtn" class="copy-btn">Copy to Clipboard</button>
                    <span id="copySuccess" class="success-message">Copied!</span>
                </div>
            </div>
        </div>

        <!-- Leaderboards Tab -->
        <div id="leaderboards" class="tab-content">
            <div class="loading" id="leaderboard-loading">Loading leaderboard data...</div>
            
            <div id="leaderboard-content" style="display: none;">
                <div class="controls">
                    <div class="controls-row">
                        <div>
                            <label>Search Username:</label>
                            <input type="text" id="username-search" placeholder="Enter username...">
                        </div>
                    </div>
                    <div class="player-filter-container">
                        <div class="player-filter-header" onclick="togglePlayerFilter()">
                            <label style="margin: 0; cursor: pointer;">Filter by Players</label>
                            <span class="filter-arrow" id="filter-arrow">▼</span>
                            <span class="selected-count" id="selected-count" style="display: none;">0</span>
                        </div>
                        <div class="player-filter-content" id="player-filter-content">
                            <div class="filter-controls">
                                <button type="button" class="reset-filter-btn" onclick="resetPlayerFilter()">Reset Filter</button>
                                <div class="exact-match-container">
                                    <input type="checkbox" id="exact-match-checkbox" onchange="handleExactMatchChange()">
                                    <label for="exact-match-checkbox">Exact Combination Match</label>
                                </div>
                            </div>
                            <div id="player-filter-roles"></div>
                        </div>
                    </div>
                </div>

                <div class="gameweek-tabs" id="leaderboard-tabs"></div>
                
                <div class="stats-summary" id="leaderboard-stats"></div>

                <div class="table-container">
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="weekly_position" title="Weekly Rank">Weekly Rank</th>
                                <th class="sortable" data-sort="username" title="Username">Username</th>
                                <th class="sortable" data-sort="weekly_points" title="Weekly Points">Weekly Pts</th>
                                <th class="sortable" data-sort="current_overall_position" title="Overall Rank">Overall Rank</th>
                                <th class="sortable" data-sort="overall_position_change" title="Overall Position Change">Change</th>
                                <th class="sortable" data-sort="current_total_score" title="Total Score">Total Score</th>
                                <th data-sort="tank" title="Tank Player">Tank</th>
                                <th data-sort="dpsOne" title="DPS Player 1">DPS 1</th>
                                <th data-sort="dpsTwo" title="DPS Player 2">DPS 2</th>
                                <th data-sort="supportOne" title="Support Player 1">Supp 1</th>
                                <th data-sort="supportTwo" title="Support Player 2">Supp 2</th>
                                <th title="Players Transferred In">Transfers In</th>
                                <th title="Players Transferred Out">Transfers Out</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-tbody"></tbody>
                    </table>
                </div>

                <div class="no-data" id="leaderboard-no-data" style="display: none;">
                    No data available for the selected filters.
                </div>
            </div>
        </div>

        <!-- Transfers Tab -->
        <div id="transfers" class="tab-content">
            <div class="loading" id="transfers-loading">Loading transfer data...</div>
            
            <div id="transfers-content" style="display: none;">
                <div class="controls">
                    <div class="controls-row">
                        <div>
                            <label>Search Player:</label>
                            <input type="text" id="player-search" placeholder="Enter player name...">
                        </div>
                        <div>
                            <label>Filter by Role:</label>
                            <select id="role-filter">
                                <option value="">All Roles</option>
                                <option value="tank">Tank</option>
                                <option value="dps">DPS</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="gameweek-tabs" id="transfers-tabs"></div>

                <div class="table-container">
                    <table id="transfers-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name" title="Player Name">Player</th>
                                <th class="sortable" data-sort="role" title="Player Role">Role</th>
                                <th class="sortable" data-sort="count" title="Number of Teams">Teams</th>
                                <th class="sortable" data-sort="percentage" title="Percentage of Teams">%</th>
                                <th class="sortable" data-sort="transferred_in" title="Number Transferred In">Trans In</th>
                                <th class="sortable" data-sort="transfer_in_pct" title="Transfer In Percentage">Trans In %</th>
                                <th class="sortable" data-sort="transferred_out" title="Number Transferred Out">Trans Out</th>
                                <th class="sortable" data-sort="transfer_out_pct" title="Transfer Out Percentage">Trans Out %</th>
                                <th class="sortable" data-sort="net_transfers" title="Net Transfers (In - Out)">Net Trans</th>
                            </tr>
                        </thead>
                        <tbody id="transfers-tbody"></tbody>
                    </table>
                </div>

                <div class="no-data" id="transfers-no-data" style="display: none;">
                    No data available for the selected filters.
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Fantasy OWCS Dashboard | Made by Umarrii | <a href="https://owfantasy.com/" target="_blank">Visit Fantasy OWCS</a></p>
    </footer>
    
    <script>
        let allData = null;
        let currentLeaderboardGameweek = null;
        let currentTransfersGameweek = null;
        let currentSortColumn = null;
        let currentSortDirection = 'desc';
        let selectedPlayers = new Set();
        let exactMatchMode = false;

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupMatchCalculator();
        });

        async function loadData() {
            try {
                const response = await fetch('/api/leaderboard-data');
                allData = await response.json();
                
                if (allData.error) {
                    console.error('Error loading data:', allData.error);
                    return;
                }

                setupLeaderboards();
                setupTransfers();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function setupMatchCalculator() {
            document.getElementById('matchForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const matchUrl = formData.get('match_url');
                
                // Always use side by side as default
                formData.set('side_by_side', 'true');
                
                const loadingDiv = document.getElementById('loading');
                const resultContainer = document.getElementById('result-container');
                const resultDiv = document.getElementById('result');
                
                loadingDiv.style.display = 'block';
                resultContainer.style.display = 'none';
                
                try {
                    const response = await fetch('/process', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        resultDiv.textContent = `Error: ${data.error}`;
                    } else {
                        resultDiv.textContent = data.report;
                    }
                    
                    loadingDiv.style.display = 'none';
                    resultContainer.style.display = 'block';
                } catch (error) {
                    loadingDiv.style.display = 'none';
                    resultDiv.textContent = `Error: ${error.message}`;
                    resultContainer.style.display = 'block';
                }
            });

            document.getElementById('copyBtn').addEventListener('click', function() {
                const resultText = document.getElementById('result').textContent;
                navigator.clipboard.writeText(resultText).then(function() {
                    const successMsg = document.getElementById('copySuccess');
                    successMsg.style.display = 'inline';
                    setTimeout(function() {
                        successMsg.style.display = 'none';
                    }, 2000);
                });
            });
        }

        function switchMainTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab and mark nav as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function setupLeaderboards() {
            const loadingEl = document.getElementById('leaderboard-loading');
            const contentEl = document.getElementById('leaderboard-content');
            
            if (!allData.leaderboards || Object.keys(allData.leaderboards).length === 0) {
                loadingEl.textContent = 'No leaderboard data available';
                return;
            }

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            // Setup tabs
            const tabsContainer = document.getElementById('leaderboard-tabs');
            const gameweeks = Object.keys(allData.leaderboards).sort((a, b) => {
                // Sort gameweeks properly (gw1, gw2, ..., playoff1, playoff2, etc.)
                const aNum = parseInt(a.replace(/\D/g, ''));
                const bNum = parseInt(b.replace(/\D/g, ''));
                if (a.includes('playoff') && !b.includes('playoff')) return 1;
                if (!a.includes('playoff') && b.includes('playoff')) return -1;
                return aNum - bNum;
            });

            gameweeks.forEach((gameweek, index) => {
                const tab = document.createElement('button');
                tab.className = 'gameweek-tab';
                tab.textContent = formatGameweekName(gameweek);
                tab.onclick = () => switchLeaderboardGameweek(gameweek);
                if (index === gameweeks.length - 1) {
                    tab.classList.add('active');
                    currentLeaderboardGameweek = gameweek;
                }
                tabsContainer.appendChild(tab);
            });

            // Setup player filter
            setupPlayerFilterLayout();
            
            // Setup table sorting
            setupTableSorting('leaderboard-table');
            
            // Display initial data
            displayLeaderboard();
            
            // Setup event listeners
            document.getElementById('username-search').addEventListener('input', displayLeaderboard);
        }

        function setupTransfers() {
            const loadingEl = document.getElementById('transfers-loading');
            const contentEl = document.getElementById('transfers-content');
            
            if (!allData.transfers || Object.keys(allData.transfers).length === 0) {
                loadingEl.textContent = 'No transfer data available';
                return;
            }

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            // Setup tabs
            const tabsContainer = document.getElementById('transfers-tabs');
            const gameweeks = Object.keys(allData.transfers).sort((a, b) => {
                const aNum = parseInt(a.replace(/\D/g, ''));
                const bNum = parseInt(b.replace(/\D/g, ''));
                if (a.includes('playoff') && !b.includes('playoff')) return 1;
                if (!a.includes('playoff') && b.includes('playoff')) return -1;
                return aNum - bNum;
            });

            gameweeks.forEach((gameweek, index) => {
                const tab = document.createElement('button');
                tab.className = 'gameweek-tab';
                tab.textContent = formatGameweekName(gameweek);
                tab.onclick = () => switchTransfersGameweek(gameweek);
                if (index === gameweeks.length - 1) {
                    tab.classList.add('active');
                    currentTransfersGameweek = gameweek;
                }
                tabsContainer.appendChild(tab);
            });

            // Setup table sorting
            setupTableSorting('transfers-table');

            // Display initial data
            displayTransfers();
            
            // Setup event listeners
            document.getElementById('player-search').addEventListener('input', displayTransfers);
            document.getElementById('role-filter').addEventListener('change', displayTransfers);
        }

        function setupTableSorting(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th.sortable');
            
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const sortKey = this.getAttribute('data-sort');
                    
                    // Toggle sort direction if clicking the same column
                    if (currentSortColumn === sortKey) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = sortKey;
                        currentSortDirection = 'desc';
                    }
                    
                    // Update header classes
                    headers.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    this.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    // Re-display data with new sorting
                    if (tableId === 'leaderboard-table') {
                        displayLeaderboard();
                    } else {
                        displayTransfers();
                    }
                });
            });
        }

        function formatGameweekName(gameweek) {
            if (gameweek.startsWith('playoff')) {
                return gameweek.replace('playoff', 'Playoff ');
            }
            return gameweek.toUpperCase();
        }

        function setupPlayerFilterLayout() {
            const rolesContainer = document.getElementById('player-filter-roles');
            
            // Get all unique players organized by role
            const playersByRole = {
                tank: new Set(),
                dps: new Set(),
                support: new Set()
            };
            
            Object.values(allData.leaderboards).forEach(gw => {
                gw.data.forEach(entry => {
                    if (entry.tank) playersByRole.tank.add(entry.tank);
                    if (entry.dpsOne) playersByRole.dps.add(entry.dpsOne);
                    if (entry.dpsTwo) playersByRole.dps.add(entry.dpsTwo);
                    if (entry.supportOne) playersByRole.support.add(entry.supportOne);
                    if (entry.supportTwo) playersByRole.support.add(entry.supportTwo);
                });
            });

            // Build the roles HTML with case-insensitive sorting
            let rolesHTML = '';
            
            // Tank section
            if (playersByRole.tank.size > 0) {
                rolesHTML += '<div class="role-section">';
                rolesHTML += '<div class="role-title tank">Tank</div>';
                rolesHTML += '<div class="players-list">';
                Array.from(playersByRole.tank).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(player => {
                    rolesHTML += `
                        <div class="player-checkbox">
                            <input type="checkbox" id="player-${player}" value="${player}" onchange="handlePlayerCheckbox('${player}')">
                            <label for="player-${player}">${player}</label>
                        </div>
                    `;
                });
                rolesHTML += '</div></div>';
            }
            
            // DPS section
            if (playersByRole.dps.size > 0) {
                rolesHTML += '<div class="role-section">';
                rolesHTML += '<div class="role-title damage">Damage</div>';
                rolesHTML += '<div class="players-list">';
                Array.from(playersByRole.dps).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(player => {
                    rolesHTML += `
                        <div class="player-checkbox">
                            <input type="checkbox" id="player-${player}" value="${player}" onchange="handlePlayerCheckbox('${player}')">
                            <label for="player-${player}">${player}</label>
                        </div>
                    `;
                });
                rolesHTML += '</div></div>';
            }
            
            // Support section
            if (playersByRole.support.size > 0) {
                rolesHTML += '<div class="role-section">';
                rolesHTML += '<div class="role-title support">Support</div>';
                rolesHTML += '<div class="players-list">';
                Array.from(playersByRole.support).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(player => {
                    rolesHTML += `
                        <div class="player-checkbox">
                            <input type="checkbox" id="player-${player}" value="${player}" onchange="handlePlayerCheckbox('${player}')">
                            <label for="player-${player}">${player}</label>
                        </div>
                    `;
                });
                rolesHTML += '</div></div>';
            }
            
            rolesContainer.innerHTML = rolesHTML;
        }

        function togglePlayerFilter() {
            const content = document.getElementById('player-filter-content');
            const arrow = document.getElementById('filter-arrow');
            
            const isExpanded = content.classList.contains('expanded');
            if (isExpanded) {
                content.classList.remove('expanded');
                arrow.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
            }
        }

        function handlePlayerCheckbox(player) {
            if (selectedPlayers.has(player)) {
                selectedPlayers.delete(player);
            } else {
                selectedPlayers.add(player);
            }
            updateSelectedCount();
            displayLeaderboard();
        }

        function handleExactMatchChange() {
            exactMatchMode = document.getElementById('exact-match-checkbox').checked;
            displayLeaderboard();
        }

        function resetPlayerFilter() {
            selectedPlayers.clear();
            exactMatchMode = false;
            
            // Uncheck all checkboxes
            document.querySelectorAll('#player-filter-roles input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Uncheck exact match checkbox
            document.getElementById('exact-match-checkbox').checked = false;
            
            updateSelectedCount();
            displayLeaderboard();
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selected-count');
            
            if (selectedPlayers.size === 0) {
                countEl.style.display = 'none';
            } else {
                countEl.textContent = selectedPlayers.size;
                countEl.style.display = 'inline';
            }
        }

        function switchLeaderboardGameweek(gameweek) {
            currentLeaderboardGameweek = gameweek;
            
            // Update active tab
            document.querySelectorAll('#leaderboard-tabs .gameweek-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayLeaderboard();
        }

        function switchTransfersGameweek(gameweek) {
            currentTransfersGameweek = gameweek;
            
            // Update active tab
            document.querySelectorAll('#transfers-tabs .gameweek-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayTransfers();
        }

        function sortData(data, sortKey, direction) {
            return data.sort((a, b) => {
                let aVal = a[sortKey];
                let bVal = b[sortKey];
                
                // Handle numeric values
                if (typeof aVal === 'string' && !isNaN(parseFloat(aVal))) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
        }

        function displayLeaderboard() {
            if (!currentLeaderboardGameweek || !allData.leaderboards[currentLeaderboardGameweek]) {
                return;
            }

            const gameweekData = allData.leaderboards[currentLeaderboardGameweek];
            const searchTerm = document.getElementById('username-search').value.toLowerCase();

            // Filter data based on mode
            let filteredData = gameweekData.data.filter(entry => {
                const matchesSearch = !searchTerm || entry.username.toLowerCase().includes(searchTerm);
                
                if (selectedPlayers.size === 0) {
                    return matchesSearch;
                }

                if (exactMatchMode) {
                    // Exact match mode - ALL selected players must be in the team (AND operation)
                    const teamPlayers = [
                        entry.tank,
                        entry.dpsOne,
                        entry.dpsTwo,
                        entry.supportOne,
                        entry.supportTwo
                    ];
                    
                    // Check if ALL selected players are in this team
                    const hasAllSelectedPlayers = Array.from(selectedPlayers).every(player => 
                        teamPlayers.includes(player)
                    );
                    
                    return matchesSearch && hasAllSelectedPlayers;
                } else {
                    // Regular mode - ANY selected player can be in the team (OR operation)
                    const hasAnySelectedPlayer = Array.from(selectedPlayers).some(player => 
                        entry.tank === player || 
                        entry.dpsOne === player || 
                        entry.dpsTwo === player || 
                        entry.supportOne === player || 
                        entry.supportTwo === player
                    );
                    
                    return matchesSearch && hasAnySelectedPlayer;
                }
            });

            // Calculate filtered stats
            const filteredTeamCount = filteredData.length;
            const filteredTotalPoints = filteredData.reduce((sum, entry) => sum + entry.weekly_points, 0);
            const filteredAveragePoints = filteredTeamCount > 0 ? (filteredTotalPoints / filteredTeamCount).toFixed(1) : 0;

            // Update stats
            const statsContainer = document.getElementById('leaderboard-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>${filteredTeamCount}</h3>
                    <p>Teams Displayed</p>
                </div>
                <div class="stat-card">
                    <h3>${gameweekData.total_participants}</h3>
                    <p>Total Participants</p>
                </div>
                <div class="stat-card">
                    <h3>${filteredAveragePoints}</h3>
                    <p>Average Points (Filtered)</p>
                </div>
            `;

            // Sort data if needed
            if (currentSortColumn) {
                filteredData = sortData(filteredData, currentSortColumn, currentSortDirection);
            }

            const tbody = document.getElementById('leaderboard-tbody');
            const noDataEl = document.getElementById('leaderboard-no-data');

            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }

            noDataEl.style.display = 'none';
            tbody.innerHTML = filteredData.map(entry => `
                <tr>
                    <td>${entry.weekly_position}</td>
                    <td><strong>${entry.username}</strong></td>
                    <td>${entry.weekly_points}</td>
                    <td>${entry.current_overall_position}</td>
                    <td class="position-change ${getPositionChangeClass(entry.overall_position_change)}">
                        ${entry.overall_position_change || 0}
                    </td>
                    <td>${entry.current_total_score}</td>
                    <td><span class="role-tank">${entry.tank || '-'}</span></td>
                    <td><span class="role-dps">${entry.dpsOne || '-'}</span></td>
                    <td><span class="role-dps">${entry.dpsTwo || '-'}</span></td>
                    <td><span class="role-support">${entry.supportOne || '-'}</span></td>
                    <td><span class="role-support">${entry.supportTwo || '-'}</span></td>
                    <td class="transfer-in">${entry.transferred_in && entry.transferred_in.length > 0 ? entry.transferred_in.join(', ') : '-'}</td>
                    <td class="transfer-out">${entry.transferred_out && entry.transferred_out.length > 0 ? entry.transferred_out.join(', ') : '-'}</td>
                </tr>
            `).join('');
        }

        function displayTransfers() {
            if (!currentTransfersGameweek || !allData.transfers[currentTransfersGameweek]) {
                return;
            }

            const transferData = allData.transfers[currentTransfersGameweek];
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;

            // Filter data
            let filteredData = transferData.filter(player => {
                const matchesSearch = !searchTerm || player.name.toLowerCase().includes(searchTerm);
                const matchesRole = !roleFilter || player.role === roleFilter;
                
                return matchesSearch && matchesRole;
            });

            // Sort data if needed
            if (currentSortColumn) {
                filteredData = sortData(filteredData, currentSortColumn, currentSortDirection);
            }

            const tbody = document.getElementById('transfers-tbody');
            const noDataEl = document.getElementById('transfers-no-data');

            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }

            noDataEl.style.display = 'none';
            tbody.innerHTML = filteredData.map(player => `
                <tr>
                    <td><strong>${player.name}</strong></td>
                    <td><span class="role-${player.role}">${player.role.toUpperCase()}</span></td>
                    <td>${player.count}</td>
                    <td>${player.percentage}%</td>
                    <td class="transfer-in">${player.transferred_in || 0}</td>
                    <td class="transfer-in">${player.transfer_in_pct || 0}%</td>
                    <td class="transfer-out">${player.transferred_out || 0}</td>
                    <td class="transfer-out">${player.transfer_out_pct || 0}%</td>
                    <td class="position-change ${getNetTransferClass(player.net_transfers || 0)}">
                        ${player.net_transfers || 0}
                    </td>
                </tr>
            `).join('');
        }

        function getPositionChangeClass(change) {
            if (!change || change === 0) return 'position-same';
            
            const absChange = Math.abs(change);
            let baseClass = change > 0 ? 'position-up' : 'position-down';
            
            // Add intensity classes based on magnitude
            if (absChange >= 20) {
                baseClass += ' change-huge-' + (change > 0 ? 'up' : 'down');
            } else if (absChange >= 10) {
                baseClass += ' change-big-' + (change > 0 ? 'up' : 'down');
            } else if (absChange >= 5) {
                baseClass += ' change-small-' + (change > 0 ? 'up' : 'down');
            }
            
            return baseClass;
        }

        function getNetTransferClass(netTransfers) {
            if (netTransfers > 0) return 'position-up';
            if (netTransfers < 0) return 'position-down';
            return 'position-same';
        }
    </script>
</body>
</html>